{
  "routine_id": "dws_gem_product_tag_value_dist_inc_1d_function",
  "dataset_id": "favie_dw",
  "project_id": "srpproduct-dc37e",
  "full_routine_id": "srpproduct-dc37e.favie_dw.dws_gem_product_tag_value_dist_inc_1d_function",
  "routine_type": "TABLE_VALUED_FUNCTION",
  "language": "SQL",
  "created": "2026-01-25T10:22:25.132000+00:00",
  "modified": "2026-01-25T10:22:25.132000+00:00",
  "description": "",
  "definition": "WITH category_base AS (\n    SELECT\n      PARSE_DATE('%Y-%m-%d', dt) AS dt,\n      f_sku_id,\n      collage_category\n    FROM `srpproduct-dc37e.favie_algo.dwd_gem_product_collage_category_full_1d`\n    WHERE dt = CAST(dt_param AS STRING)\n  ),\n\n  -- ② 结构化标签表\n  structured_tags AS (\n    SELECT\n      dt,\n      f_sku_id,\n      occasion,\n      material\n    FROM `srpproduct-dc37e.favie_algo.dwd_gem_product_structured_normalized_full_1d`\n    WHERE dt = dt_param\n  ),\n\n  -- ③ 商品库表（获取site）\n  product_detail AS (\n    SELECT\n      f_sku_id,\n      site\n    FROM `favie_dw.dwd_favie_product_detail_full_1d`\n    WHERE dt = CAST(dt_param AS STRING)\n  ),\n\n  -- ④ JOIN 三张表\n  joined AS (\n    SELECT\n      c.dt,\n      p.site,\n      c.collage_category,\n      c.f_sku_id,\n      s.occasion,\n      s.material\n    FROM category_base c\n    LEFT JOIN structured_tags s\n      ON c.dt = s.dt AND c.f_sku_id = s.f_sku_id\n    LEFT JOIN product_detail p\n      ON c.f_sku_id = p.f_sku_id\n  ),\n\n  -- ⑤ 展开 occasion 标签值\n  occasion_values AS (\n    SELECT\n      dt,\n      site,\n      collage_category,\n      f_sku_id,\n      'occasion' AS tag,\n      TRIM(occasion_value) AS tag_value\n    FROM joined,\n    UNNEST(SPLIT(TRIM(occasion, '[]\"'), ',')) AS occasion_value\n    WHERE occasion IS NOT NULL\n      AND occasion != ''\n      AND collage_category NOT IN ('Non-Outfit', 'null')\n      AND collage_category IS NOT NULL\n      AND TRIM(occasion_value) != ''\n  ),\n\n  -- ⑥ 展开 material 标签值\n  material_values AS (\n    SELECT\n      dt,\n      site,\n      collage_category,\n      f_sku_id,\n      'material' AS tag,\n      TRIM(material_value) AS tag_value\n    FROM joined,\n    UNNEST(SPLIT(TRIM(material, '[]\"'), ',')) AS material_value\n    WHERE material IS NOT NULL\n      AND material != ''\n      AND collage_category IS NOT NULL\n      AND collage_category != 'null'\n      AND TRIM(material_value) != ''\n  ),\n\n  -- ⑦ UNION ALL 合并两个标签\n  all_tag_values AS (\n    SELECT * FROM occasion_values\n    UNION ALL\n    SELECT * FROM material_values\n  )\n\n  -- ⑧ 最终聚合\n  SELECT\n    dt,\n    site,\n    collage_category,\n    tag,\n    tag_value,\n    COUNT(DISTINCT f_sku_id) AS sku_cnt\n  FROM all_tag_values\n  GROUP BY dt, site, collage_category, tag, tag_value",
  "arguments": [
    {
      "name": "dt_param",
      "data_type": "StandardSqlDataType(type_kind=<StandardSqlTypeNames.DATE: 'DATE'>, ...)",
      "mode": null
    }
  ],
  "return_type": null
}