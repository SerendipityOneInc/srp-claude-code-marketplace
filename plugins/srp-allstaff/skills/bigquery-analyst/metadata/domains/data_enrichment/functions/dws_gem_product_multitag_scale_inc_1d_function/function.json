{
  "routine_id": "dws_gem_product_multitag_scale_inc_1d_function",
  "dataset_id": "favie_dw",
  "project_id": "srpproduct-dc37e",
  "full_routine_id": "srpproduct-dc37e.favie_dw.dws_gem_product_multitag_scale_inc_1d_function",
  "routine_type": "TABLE_VALUED_FUNCTION",
  "language": "SQL",
  "created": "2026-01-25T10:11:30.607000+00:00",
  "modified": "2026-01-25T10:11:30.607000+00:00",
  "description": "",
  "definition": "WITH category_base AS (\n    SELECT\n      PARSE_DATE('%Y-%m-%d', dt) AS dt,\n      f_sku_id,\n      collage_category\n    FROM `srpproduct-dc37e.favie_algo.dwd_gem_product_collage_category_full_1d`\n    WHERE dt = CAST(dt_param AS STRING)\n  ),\n\n  -- ② 结构化标签表\n  structured_tags AS (\n    SELECT\n      dt,\n      f_sku_id,\n      season,\n      occasion,\n      material,\n      style,\n      features,\n      function\n    FROM `srpproduct-dc37e.favie_algo.dwd_gem_product_structured_normalized_full_1d`\n    WHERE dt = dt_param\n  ),\n\n  -- ③ 商品库表（获取site）\n  product_detail AS (\n    SELECT\n      f_sku_id,\n      site\n    FROM `favie_dw.dwd_favie_product_detail_full_1d`\n    WHERE dt = CAST(dt_param AS STRING)\n  ),\n\n  -- ④ JOIN 三张表\n  joined AS (\n    SELECT\n      c.dt,\n      p.site,\n      c.collage_category,\n      c.f_sku_id,\n      s.season,\n      s.occasion,\n      s.material,\n      s.style,\n      s.features,\n      s.function\n    FROM category_base c\n    LEFT JOIN structured_tags s\n      ON c.dt = s.dt AND c.f_sku_id = s.f_sku_id\n    LEFT JOIN product_detail p\n      ON c.f_sku_id = p.f_sku_id\n  ),\n\n  -- ⑤ 计算每个多值字段的标签数量并分桶\n  tag_counts AS (\n    SELECT\n      dt,\n      site,\n      collage_category,\n      f_sku_id,\n\n      -- season 标签数量（假设格式为逗号分隔的字符串或 JSON 数组）\n      CASE\n        WHEN season IS NULL OR season = '' THEN 0\n        ELSE ARRAY_LENGTH(SPLIT(TRIM(season, '[]\"'), ','))\n      END AS season_cnt,\n\n      -- occasion 标签数量\n      CASE\n        WHEN occasion IS NULL OR occasion = '' THEN 0\n        ELSE ARRAY_LENGTH(SPLIT(TRIM(occasion, '[]\"'), ','))\n      END AS occasion_cnt,\n\n      -- material 标签数量\n      CASE\n        WHEN material IS NULL OR material = '' THEN 0\n        ELSE ARRAY_LENGTH(SPLIT(TRIM(material, '[]\"'), ','))\n      END AS material_cnt,\n\n      -- style 标签数量\n      CASE\n        WHEN style IS NULL OR style = '' THEN 0\n        ELSE ARRAY_LENGTH(SPLIT(TRIM(style, '[]\"'), ','))\n      END AS style_cnt,\n\n      -- features 标签数量\n      CASE\n        WHEN features IS NULL OR features = '' THEN 0\n        ELSE ARRAY_LENGTH(SPLIT(TRIM(features, '[]\"'), ','))\n      END AS features_cnt,\n\n      -- function 标签数量\n      CASE\n        WHEN function IS NULL OR function = '' THEN 0\n        ELSE ARRAY_LENGTH(SPLIT(TRIM(function, '[]\"'), ','))\n      END AS function_cnt\n\n    FROM joined\n  ),\n\n  -- ⑥ 转换为桶\n  tag_buckets AS (\n    SELECT\n      dt,\n      site,\n      collage_category,\n      f_sku_id,\n\n      -- season 分桶\n      CASE\n        WHEN season_cnt = 0 THEN '0'\n        WHEN season_cnt = 1 THEN '1'\n        WHEN season_cnt = 2 THEN '2'\n        WHEN season_cnt = 3 THEN '3'\n        WHEN season_cnt = 4 THEN '4'\n        ELSE '5+'\n      END AS season_bucket,\n\n      -- occasion 分桶\n      CASE\n        WHEN occasion_cnt = 0 THEN '0'\n        WHEN occasion_cnt = 1 THEN '1'\n        WHEN occasion_cnt = 2 THEN '2'\n        WHEN occasion_cnt = 3 THEN '3'\n        WHEN occasion_cnt = 4 THEN '4'\n        ELSE '5+'\n      END AS occasion_bucket,\n\n      -- material 分桶\n      CASE\n        WHEN material_cnt = 0 THEN '0'\n        WHEN material_cnt = 1 THEN '1'\n        WHEN material_cnt = 2 THEN '2'\n        WHEN material_cnt = 3 THEN '3'\n        WHEN material_cnt = 4 THEN '4'\n        ELSE '5+'\n      END AS material_bucket,\n\n      -- style 分桶\n      CASE\n        WHEN style_cnt = 0 THEN '0'\n        WHEN style_cnt = 1 THEN '1'\n        WHEN style_cnt = 2 THEN '2'\n        WHEN style_cnt = 3 THEN '3'\n        WHEN style_cnt = 4 THEN '4'\n        ELSE '5+'\n      END AS style_bucket,\n\n      -- features 分桶\n      CASE\n        WHEN features_cnt = 0 THEN '0'\n        WHEN features_cnt = 1 THEN '1'\n        WHEN features_cnt = 2 THEN '2'\n        WHEN features_cnt = 3 THEN '3'\n        WHEN features_cnt = 4 THEN '4'\n        ELSE '5+'\n      END AS features_bucket,\n\n      -- function 分桶\n      CASE\n        WHEN function_cnt = 0 THEN '0'\n        WHEN function_cnt = 1 THEN '1'\n        WHEN function_cnt = 2 THEN '2'\n        WHEN function_cnt = 3 THEN '3'\n        WHEN function_cnt = 4 THEN '4'\n        ELSE '5+'\n      END AS function_bucket\n\n    FROM tag_counts\n  ),\n\n  -- ⑦ UNION ALL：展开为长表\n  multitag_scale AS (\n    -- season\n    SELECT\n      dt, site, collage_category,\n      'season' AS tag,\n      season_bucket AS tag_cnt_bucket,\n      COUNT(DISTINCT f_sku_id) AS sku_cnt\n    FROM tag_buckets\n    WHERE collage_category IS NOT NULL AND collage_category != 'null'\n    GROUP BY dt, site, collage_category, season_bucket\n\n    UNION ALL\n\n    -- occasion\n    SELECT\n      dt, site, collage_category,\n      'occasion' AS tag,\n      occasion_bucket AS tag_cnt_bucket,\n      COUNT(DISTINCT f_sku_id) AS sku_cnt\n    FROM tag_buckets\n    WHERE collage_category NOT IN ('Non-Outfit', 'null') AND collage_category IS NOT NULL\n    GROUP BY dt, site, collage_category, occasion_bucket\n\n    UNION ALL\n\n    -- material\n    SELECT\n      dt, site, collage_category,\n      'material' AS tag,\n      material_bucket AS tag_cnt_bucket,\n      COUNT(DISTINCT f_sku_id) AS sku_cnt\n    FROM tag_buckets\n    WHERE collage_category IS NOT NULL AND collage_category != 'null'\n    GROUP BY dt, site, collage_category, material_bucket\n\n    UNION ALL\n\n    -- style\n    SELECT\n      dt, site, collage_category,\n      'style' AS tag,\n      style_bucket AS tag_cnt_bucket,\n      COUNT(DISTINCT f_sku_id) AS sku_cnt\n    FROM tag_buckets\n    WHERE collage_category IS NOT NULL AND collage_category != 'null'\n    GROUP BY dt, site, collage_category, style_bucket\n\n    UNION ALL\n\n    -- features\n    SELECT\n      dt, site, collage_category,\n      'features' AS tag,\n      features_bucket AS tag_cnt_bucket,\n      COUNT(DISTINCT f_sku_id) AS sku_cnt\n    FROM tag_buckets\n    WHERE collage_category IS NOT NULL AND collage_category != 'null'\n    GROUP BY dt, site, collage_category, features_bucket\n\n    UNION ALL\n\n    -- function\n    SELECT\n      dt, site, collage_category,\n      'function' AS tag,\n      function_bucket AS tag_cnt_bucket,\n      COUNT(DISTINCT f_sku_id) AS sku_cnt\n    FROM tag_buckets\n    WHERE collage_category IN ('Top', 'Bottom', 'One-Piece', 'Outerwear', 'Shoes', 'Underwear', 'Bag', 'Watch', 'Glasses')\n    GROUP BY dt, site, collage_category, function_bucket\n  )\n\n  SELECT\n    dt,\n    site,\n    collage_category,\n    tag,\n    tag_cnt_bucket,\n    sku_cnt\n  FROM multitag_scale",
  "arguments": [
    {
      "name": "dt_param",
      "data_type": "StandardSqlDataType(type_kind=<StandardSqlTypeNames.DATE: 'DATE'>, ...)",
      "mode": null
    }
  ],
  "return_type": null
}