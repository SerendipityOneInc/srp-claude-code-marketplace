{
  "routine_id": "dws_favie_product_info_full_1d_function",
  "dataset_id": "favie_dw",
  "project_id": "srpproduct-dc37e",
  "full_routine_id": "srpproduct-dc37e.favie_dw.dws_favie_product_info_full_1d_function",
  "routine_type": "TABLE_VALUED_FUNCTION",
  "language": "SQL",
  "created": "2026-01-30T02:05:45.101000+00:00",
  "modified": "2026-01-30T02:05:45.101000+00:00",
  "description": "",
  "definition": "WITH base_with_arrays AS (\n        SELECT \n            -- 明确列出所有需要的字段\n            f_sku_id,\n            f_spu_id,\n            site,\n            link,\n            brand,\n            keywords,\n            price,\n            f_creates_at,\n            attributes,\n            seller  as sellers,\n            best_seller_rank,\n            review_summary,\n            variants_str,\n            f_system_tags,\n            f_videos,\n            f_categories,\n            -- 一次性提取类目数组\n            ARRAY(\n                SELECT JSON_EXTRACT_SCALAR(cat, '$.name')\n                FROM UNNEST(JSON_EXTRACT_ARRAY(f_categories)) AS cat\n            ) AS category_array\n        FROM `favie_dw.dwd_favie_product_detail_full_1d`\n        WHERE dt IS NOT NULL \n            AND PARSE_DATE('%Y-%m-%d', dt) = dt_param\n    )\n    \n    SELECT\n        dt_param AS dt,\n        \n        -- 基础信息\n        f_sku_id,\n        keywords,\n        f_spu_id,\n        link,\n        brand AS brand_name,\n        site,\n        SAFE_CAST(JSON_EXTRACT_SCALAR(price, '$.value') AS INT64) AS price,\n        \n        -- 上架时间\n        DATE(TIMESTAMP_SECONDS(SAFE_CAST(f_creates_at AS INT64))) AS launch_date,\n        \n        -- 包装信息\n        cast(null as FLOAT64) AS package_weight,\n        cast(null as int64) AS package_dimensions,\n        \n        -- 卖家信息\n        sellers,\n        \n        -- 类目层级（直接用数组索引，只需一次 UNNEST）\n        IF(ARRAY_LENGTH(category_array) > 0, category_array[OFFSET(0)], NULL) AS category_level_1,\n        IF(ARRAY_LENGTH(category_array) > 1, category_array[OFFSET(1)], NULL) AS category_level_2,\n        IF(ARRAY_LENGTH(category_array) > 2, category_array[OFFSET(2)], NULL) AS category_level_3,\n        IF(ARRAY_LENGTH(category_array) > 3, category_array[OFFSET(3)], NULL) AS category_level_4,\n        IF(ARRAY_LENGTH(category_array) > 4, category_array[OFFSET(4)], NULL) AS category_level_5,\n        IF(ARRAY_LENGTH(category_array) > 5, category_array[OFFSET(5)], NULL) AS category_level_6,\n        IF(ARRAY_LENGTH(category_array) > 6, category_array[OFFSET(6)], NULL) AS category_level_7,\n        IF(ARRAY_LENGTH(category_array) > 7, category_array[OFFSET(7)], NULL) AS category_level_8,\n        IF(ARRAY_LENGTH(category_array) > 8, category_array[OFFSET(8)], NULL) AS category_level_9,\n        IF(ARRAY_LENGTH(category_array) > 9, category_array[OFFSET(9)], NULL) AS category_level_10,\n        \n        -- 主图视频\n        CASE WHEN f_videos IS NOT NULL AND f_videos != '[]' THEN TRUE ELSE FALSE END AS has_main_video,\n        \n        -- 商品标识\n        cast(null as string) AS product_badges,\n        \n        -- FBA费用（待补充）\n        CAST(NULL AS FLOAT64) AS fba_fee,\n        \n        -- 销量相关（待补充）\n        CAST(NULL AS INT64) AS monthly_sale_cnt,\n        CAST(NULL AS FLOAT64) AS monthly_sale_amt,\n        CAST(NULL AS INT64) AS monthly_parent_sale_cnt,\n        CAST(NULL AS FLOAT64) AS monthly_parent_sale_amt,\n        CAST(NULL AS FLOAT64) AS monthly_sales_growth_rate,\n        CAST(NULL AS FLOAT64) AS monthly_parent_sales_growth_rate,\n        \n        -- BSR排名\n        SAFE_CAST(JSON_EXTRACT_SCALAR(best_seller_rank, '$[0].rank') AS INT64) AS big_category_bsr,\n        SAFE_CAST(JSON_EXTRACT_SCALAR(best_seller_rank, '$[1].rank') AS INT64) AS small_category_bsr,\n        \n        -- BSR增长（待补充）\n        CAST(NULL AS INT64) AS big_bsr_growth,\n        CAST(NULL AS FLOAT64) AS big_bsr_growth_rate,\n        CAST(NULL AS INT64) AS small_bsr_growth,\n        CAST(NULL AS FLOAT64) AS small_bsr_growth_rate,\n        \n        -- 变体数\n        COALESCE(\n            ARRAY_LENGTH(SPLIT(REGEXP_REPLACE(variants_str, r'[\\[\\]\"]', ''), ',')),\n            0\n        ) AS variant_cnt,\n        \n        -- 卖家数（待补充）\n        CAST(NULL AS INT64) AS seller_cnt,\n        \n        -- 评分评论\n        CAST(SAFE_CAST(JSON_EXTRACT_SCALAR(review_summary, '$.rating') AS FLOAT64) AS INT64) AS rating_amt,\n        SAFE_CAST(JSON_EXTRACT_SCALAR(review_summary, '$.ratings_total') AS INT64) AS rating_cnt,\n        SAFE_CAST(JSON_EXTRACT_SCALAR(review_summary, '$.ratings_total') AS INT64) AS review_cnt,\n        \n        -- 月评新增（待补充）\n        CAST(NULL AS INT64) AS monthly_new_rating_cnt,\n        CAST(NULL AS FLOAT64) AS monthly_rating_rate,\n        \n        -- Q&A数量（待补充）\n        CAST(NULL AS INT64) AS qa_cnt,\n        \n        -- 毛利率（待补充）\n        CAST(NULL AS FLOAT64) AS gross_margin_rate,\n        \n        -- LQS评分（待补充）\n        CAST(NULL AS FLOAT64) AS listing_quality_score,\n        \n        -- 配送方式\n        CASE \n            WHEN f_system_tags LIKE '%fba%' THEN 'FBA'\n            WHEN f_system_tags LIKE '%fbm%' THEN 'FBM'\n            WHEN f_system_tags LIKE '%amz%' THEN 'AMZ'\n            ELSE NULL\n        END AS fulfillment_type\n        \n    FROM base_with_arrays",
  "arguments": [
    {
      "name": "dt_param",
      "data_type": "StandardSqlDataType(type_kind=<StandardSqlTypeNames.DATE: 'DATE'>, ...)",
      "mode": null
    }
  ],
  "return_type": null
}