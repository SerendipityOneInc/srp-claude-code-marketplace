with gem_search_ha3_data as (
    SELECT
      t1.trace_id AS trace_id,
      t1.task_id AS task_id,
      t1.raw_query AS raw_query,
      t1.rewrite_queries AS rewrite_queries,
      t1.qr_query AS qr_query,
      t1.qp_query as qp_query,
      t1.query_modality as query_modality,
      "ha3" AS search_engine,
      t2.product_sku_id AS product_sku_id,
      t2.product_site AS product_site,
      t2.product_site AS product_shop_site,
      t2.product_brand AS product_brand,
      t2.product_price_currency AS product_price_currency,
      t2.product_price_value AS product_price_value,
      t2.product_price_raw AS product_price_raw,
      t2.product_link AS product_link,
      t2.product_query AS product_query,
      t2.product_image_link as product_image_link,
      t2.product_rating AS product_rating,
      t2.product_ratings_total AS product_ratings_total,
      t2.product_cate_tag AS product_cate_tag,
      t2.product_title AS product_title,
      t2.product_updates_at AS product_updates_at,
      t2.product_creates_at AS product_creates_at,
      t1.log_timestamp as se_recall_timestamp,
      t2.log_timestamp as gem_search_timestamp,
      t3.moodboard_id AS moodboard_id,
      t3.log_timestamp as moodboard_timestamp,
      t1.query_image_url AS query_image_url,
      t1.query_image_description AS query_image_description,
      t1.query_image_height AS query_image_height,
      t1.query_image_width AS query_image_width,
      t1.query_image_tag AS query_image_tag,
      t1.device_id as device_id,
      t1.user_type AS user_type,
      t1.is_internal_user AS is_internal_user,
      t1.user_login_type AS user_login_type,
      t1.user_tenure_type AS user_tenure_type,
      t1.country_name AS country_name,
      t1.platform AS platform,
      t1.appsflyer_id AS appsflyer_id,
      t1.ad_source AS ad_source,
      t1.ad_campaign_id AS ad_campaign_id,
      t1.ad_group_id AS ad_group_id,
      t1.ad_id AS ad_id,
      
      t1.query_intention AS query_intention,
      t1.reasoning AS reasoning,
      t1.app_version AS app_version,
      t1.query_source AS query_source,
      t1.dt AS dt
    FROM (select * from favie_dw.dwd_favie_gem_search_query_inc_1d where dt = dt_param) t1
    LEFT OUTER JOIN (select * from favie_dw.dwd_favie_gem_search_inc_1d_view where dt = dt_param and search_engine = "ha3") t2
      ON t1.dt = t2.dt AND t1.trace_id = t2.trace_id 
    LEFT OUTER JOIN (select * from favie_dw.dwd_favie_gem_moodboards_inc_1d_view where dt = dt_param) t3
      ON t2.dt = t3.dt AND t2.trace_id = t3.trace_id AND t2.product_sku_id = t3.product_sku_id

  )

  -- gem_search_not_ha3_data as(
  --   SELECT
  --     t2.trace_id AS trace_id,
  --     t4.task_id AS task_id,
  --     t4.raw_query AS raw_query,
  --     t4.rewrite_queries AS rewrite_queries,
  --     cast(null as STRING) AS qr_query,
  --     cast(null as STRING) as qp_query,
  --     t4.query_modality as query_modality,
  --     t2.search_engine AS search_engine,
  --     t2.product_sku_id AS product_sku_id,
  --     t2.product_site AS product_site,
  --     t2.product_site as product_shop_site,
  --     t2.product_brand AS product_brand,
  --     t2.product_price_currency AS product_price_currency,
  --     t2.product_price_value AS product_price_value,
  --     t2.product_price_raw AS product_price_raw,
  --     t2.product_link AS product_link,
  --     t2.product_query AS product_query,
  --     t2.product_image_link as product_image_link,
  --     t2.product_rating AS product_rating,
  --     t2.product_ratings_total AS product_ratings_total,
  --     t2.product_cate_tag AS product_cate_tag,
  --     t2.product_title AS product_title,
  --     t2.product_updates_at AS product_updates_at,
  --     t2.product_creates_at AS product_creates_at,
  --     t2.log_timestamp as se_recall_timestamp,
  --     t2.log_timestamp as gem_search_timestamp,
  --     t3.moodboard_id AS moodboard_id,
  --     t3.log_timestamp as moodboard_timestamp,
  --     t4.image_url AS query_image_url,
  --     t4.image_description AS query_image_description,
  --     t4.image_height AS query_image_height,
  --     t4.image_width AS query_image_width,
  --     t4.user_image_tag AS query_image_tag,
  --     t4.device_id,
  --     t4.user_type,
  --     t4.is_internal_user,
  --     t4.user_login_type,
  --     t4.user_tenure_type,
  --     t4.country_name,
  --     t4.platform,
  --     t4.app_version,
  --     t4.appsflyer_id,
  --     t4.ad_source,
  --     t4.ad_campaign_id,
  --     t4.ad_group_id,
  --     t4.ad_id,
  --     t4.intention AS query_intention,
  --     t4.reasoning AS reasoning,
  --     t4.query_source AS query_source,
  --     t2.dt AS dt
  --   FROM  (select * from favie_dw.dwd_favie_gem_search_inc_1d_view where dt = dt_param and search_engine != "ha3") t2
  --   LEFT OUTER JOIN (select * from favie_dw.dwd_favie_gem_moodboards_inc_1d_view where dt = dt_param) t3
  --     ON t2.dt = t3.dt AND t2.trace_id = t3.trace_id AND t2.product_sku_id = t3.product_sku_id
  --   LEFT OUTER JOIN (select * from favie_dw.dwd_favie_gem_workflow_inc_1d where dt = dt_param) t4
  --     ON t2.dt = t4.dt AND t2.trace_id = t4.trace_id
  -- ),

  -- favie_product_detail_data as (
  --   select 
  --     product_sku_id,
  --     product_site,
  --     product_shop_site,
  --     product_link,
  --     product_title,
  --     product_price_currency,
  --     product_price_value,
  --     product_price_raw,
  --     product_brand,
  --     product_image_link,
  --     safe_cast(product_rating as float64) as product_rating,
  --     safe_cast(product_ratings_total as int64) as product_ratings_total,
  --     product_cate_tag,
  --     SAFE_CAST(GREATEST(
  --       IF(source_1_updates_at IS NULL, 0, source_1_updates_at), 
  --       IF(source_3_updates_at IS NULL, 0, source_3_updates_at),
  --       IF(source_4_updates_at IS NULL, 0, source_4_updates_at)
  --     ) as STRING) AS product_updates_at,
  --     product_creates_at,
  --     dt
  --   from(
  --       SELECT 
  --         f_sku_id as product_sku_id,
  --         `site` as product_site,
  --         shop_site as product_shop_site,
  --         link as product_link,
  --         title as product_title,
  --         json_extract_scalar(price,"$.currency") as product_price_currency,
  --         safe_cast(json_extract_scalar(price,"$.value") as int64) as product_price_value,
  --         concat(favie_dw.get_currency_symbol(json_extract_scalar(price,"$.currency")),json_extract_scalar(price,"$.value")) as product_price_raw,
  --         json_extract_scalar(brand,"$.name") as product_brand,
  --         json_extract_scalar(json_extract_array(f_image_list)[SAFE_OFFSET(0)],"$.f_link") as product_image_link,
  --         json_extract_scalar(review_summary,"$.rating") as product_rating,
  --         json_extract_scalar(review_summary,"$.ratings_total") as product_ratings_total,
  --         f_cate_tags as product_cate_tag,
  --         SAFE_CAST(JSON_EXTRACT_SCALAR(f_meta, "$.source_1_updates_at") AS INT64) AS source_1_updates_at,
  --         SAFE_CAST(JSON_EXTRACT_SCALAR(f_meta, "$.source_3_updates_at") AS INT64) AS source_3_updates_at,
  --         SAFE_CAST(JSON_EXTRACT_SCALAR(f_meta, "$.source_4_updates_at") AS INT64) AS source_4_updates_at,
  --         f_creates_at as product_creates_at,
  --         dt
  --     FROM `favie_dw.dwd_favie_product_detail_full_1d`
  --     where dt is not null and PARSE_DATE('%Y-%m-%d', dt) = dt_param
  --   )
  -- )


  SELECT
    trace_id,
    task_id,
    raw_query,
    rewrite_queries,
    qr_query,
    qp_query,
    query_modality,
    search_engine,
    product_sku_id,
    product_site,
    product_shop_site,
    product_brand,
    product_price_currency,
    product_price_value,
    product_price_raw,
    product_link,
    product_query,
    product_image_link,
    product_rating,
    product_ratings_total,
    product_cate_tag,
    product_title,
    product_updates_at,
    product_creates_at,

    se_recall_timestamp,
    gem_search_timestamp,
    moodboard_id,
    moodboard_timestamp,
    query_image_url,
    query_image_description,
    query_image_height,
    query_image_width,
    query_image_tag,
    device_id,
    user_type,
    is_internal_user,
    user_login_type,
    user_tenure_type,
    country_name,
    platform,
    app_version,
    appsflyer_id,
    ad_source,
    ad_campaign_id,
    ad_group_id,
    ad_id,
    query_intention,
    reasoning,
    query_source,
    dt
  FROM gem_search_ha3_data