CREATE VIEW `srpproduct-dc37e.favie_dw.dwd_gem_product_detail_ha3_full_xw_view`
AS with source_data as (
        SELECT
            CMD,
            f_sku_id,
            f_spu_id,
            site,
            site_info,
            sku_id,
            spu_id,
            title,
            link,
            keywords,
            brand,
            f_brand,
            category_id,
            category_names,
            f_category_id,
            f_category_names,
            description,
            user_reviews_infos,
            extend_text,
            specifications,
            item_emb,
            pidvid,
            auction_tag,
            f_level_one_category,
            f_level_leaf_category,
            attr_name,
            is_excellent,
            rating,
            ratings_total,
            local_price,
            base_price,
            uv_sum,
            seller_score,
            price_power_score,
            status,
            base_currency,
            local_currency,
            is_used,
            is_bundle,
            is_preorder,
            is_best_offer,
            is_marketplace_item,
            is_private_brand,
            recent_sales,
            is_best_seller,
            inventory,
            is_deal,
            is_lightning_deal,
            is_member_exclusive,
            discount,
            sell_amount_last_month,
            brand_score,
            saving_score,
            specifications_kv,
            text_info,
            f_images,
            feature_bullets,
            product_tag,
            style_tag,
            material_tag,
            color_tag,
            pattern_tag,
            occasion_tag,
            season_tag,
            f_main_image_url,
            seo_title,
            seo_text_info,
            demographic,
            alg_description,
            norm_brand,
            display_score,
            display_image,
            collage_category,
            is_brand_site,
            image_score,
            `length`,
            closure,
            fit_type,
            `function`,
            neckline,
            sleeve_length,
            sleeve_style,
            shape,
            features,
            color_family,
            color_tone,
            color_saturation,
            tag_text_info,
            created_time,
            product_created_at,
            product_updated_at,
            record_create_time,
            record_update_time,
            dt
        FROM `favie_dw.dwd_gem_product_detail_ha3_full_xd`
        WHERE dt is not null 
            and dt = (select max(dt) from `favie_dw.dwd_gem_product_detail_ha3_full_xd` where dt is not null)
            and index_env = 'production'
    ),
    hour_deleted_skus as (
        SELECT
            distinct f_sku_id
        FROM
            `favie_dw.dwd_gem_product_detail_ha3_inc_1h`
        WHERE dt is not null 
            and dt > (select max(dt) from `favie_dw.dwd_gem_product_detail_ha3_full_xd` where dt is not null)
            AND CMD = 'delete'
    ),
    -- archive_data as (
    --     SELECT
    --         f_sku_id
    --     FROM favie_dw.dwd_favie_product_detail_archive_inc_1d
    --     WHERE date(dt) = current_date() - interval 1 day
    -- ),
    -- final_deleted_skus as (
    --     select 
    --         f_sku_id
    --     from hour_deleted_skus
    --     union distinct
    --     select 
    --         f_sku_id
    --     from archive_data
    -- ),
    final_data as (
        select 
            sd.CMD,
            sd.f_sku_id,
            sd.f_spu_id,
            sd.site,
            sd.site_info,
            sd.sku_id,
            sd.spu_id,
            sd.title,
            sd.link,
            sd.keywords,
            sd.brand,
            sd.f_brand,
            sd.category_id,
            sd.category_names,
            sd.f_category_id,
            sd.f_category_names,
            sd.description,
            sd.user_reviews_infos,
            sd.extend_text,
            sd.specifications,
            sd.item_emb,
            sd.pidvid,
            sd.auction_tag,
            sd.f_level_one_category,
            sd.f_level_leaf_category,
            sd.attr_name,
            sd.is_excellent,
            sd.rating,
            sd.ratings_total,
            sd.local_price,
            sd.base_price,
            sd.uv_sum,
            sd.seller_score,
            sd.price_power_score,
            sd.status,
            sd.base_currency,
            sd.local_currency,
            sd.is_used,
            sd.is_bundle,
            sd.is_preorder,
            sd.is_best_offer,
            sd.is_marketplace_item,
            sd.is_private_brand,
            sd.recent_sales,
            sd.is_best_seller,
            sd.inventory,
            sd.is_deal,
            sd.is_lightning_deal,
            sd.is_member_exclusive,
            sd.discount,
            sd.sell_amount_last_month,
            sd.brand_score,
            sd.saving_score,
            sd.specifications_kv,
            sd.text_info,
            sd.f_images,
            sd.feature_bullets,
            sd.product_tag,
            sd.style_tag,
            sd.material_tag,
            sd.color_tag,
            sd.pattern_tag,
            sd.occasion_tag,
            sd.season_tag,
            sd.f_main_image_url,
            sd.seo_title,
            sd.seo_text_info,
            sd.demographic,
            sd.alg_description,
            sd.norm_brand,
            sd.display_score,
            sd.display_image,
            sd.collage_category,
            sd.is_brand_site,
            sd.image_score,
            sd.`length`,
            sd.closure,
            sd.fit_type,
            sd.`function`,
            sd.neckline,
            sd.sleeve_length,
            sd.sleeve_style,
            sd.shape,
            sd.features,
            sd.color_family,
            sd.color_tone,
            sd.color_saturation,
            sd.tag_text_info,
            sd.created_time,
            sd.product_created_at,
            sd.product_updated_at,
            sd.record_create_time,
            sd.record_update_time,
            sd.dt
        from source_data sd
        left outer join hour_deleted_skus fds
        on sd.f_sku_id = fds.f_sku_id
        where fds.f_sku_id is null
            and sd.CMD = 'add'
    )
    select 
        CMD,
        f_sku_id,
        f_spu_id,
        site,
        site_info,
        sku_id,
        spu_id,
        title,
        link,
        keywords,
        brand,
        f_brand,
        category_id,
        category_names,
        f_category_id,
        f_category_names,
        description,
        user_reviews_infos,
        extend_text,
        specifications,
        item_emb,
        pidvid,
        auction_tag,
        f_level_one_category,
        f_level_leaf_category,
        attr_name,
        is_excellent,
        rating,
        ratings_total,
        local_price,
        base_price,
        uv_sum,
        seller_score,
        price_power_score,
        status,
        base_currency,
        local_currency,
        is_used,
        is_bundle,
        is_preorder,
        is_best_offer,
        is_marketplace_item,
        is_private_brand,
        recent_sales,
        is_best_seller,
        inventory,
        is_deal,
        is_lightning_deal,
        is_member_exclusive,
        discount,
        sell_amount_last_month,
        brand_score,
        saving_score,
        specifications_kv,
        text_info,
        f_images,
        feature_bullets,
        product_tag,
        style_tag,
        material_tag,
        color_tag,
        pattern_tag,
        occasion_tag,
        season_tag,
        f_main_image_url,
        seo_title,
        seo_text_info,
        demographic,
        alg_description,
        norm_brand,
        display_score,
        display_image,
        collage_category,
        is_brand_site,
        image_score,
        `length`,
        closure,
        fit_type,
        `function`,
        neckline,
        sleeve_length,
        sleeve_style,
        shape,
        features,
        color_family,
        color_tone,
        color_saturation,
        tag_text_info,
        created_time,
        product_created_at,
        product_updated_at,
        record_create_time,
        record_update_time,
        dt 
    from final_data;